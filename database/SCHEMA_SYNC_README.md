# Schema çƒ­æ›´æ–°åŒæ­¥ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

Schema çƒ­æ›´æ–°åŒæ­¥ç³»ç»Ÿæ˜¯ä¸€ä¸ªå£°æ˜å¼çš„æ•°æ®åº“åŒæ­¥å·¥å…·ï¼Œé€šè¿‡ç»´æŠ¤ç»Ÿä¸€çš„ `schema.json` æ–‡ä»¶æ¥ç®¡ç†æ‰€æœ‰ `mini_` å‰ç¼€è¡¨çš„ç»“æ„ã€‚æ¯æ¬¡è¿è¡ŒåŒæ­¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å¯¹æ¯”æ•°æ®åº“å’Œ schema æ–‡ä»¶ï¼Œç”Ÿæˆå¹¶æ‰§è¡Œå¿…è¦çš„ SQL è¯­å¥æ¥ä¿æŒæ•°æ®åº“ç»“æ„æœ€æ–°ã€‚

## å¿«é€Ÿå¼€å§‹

### 1. åˆå§‹åŒ– Schema æ–‡ä»¶

é¦–æ¬¡ä½¿ç”¨å‰ï¼Œéœ€è¦ä»ç°æœ‰æ•°æ®åº“ç”Ÿæˆåˆå§‹ schema.jsonï¼š

**æ–¹å¼ 1ï¼šä½¿ç”¨ Web UIï¼ˆæ¨èï¼‰**
1. è®¿é—®ï¼š`http://localhost:8082/sync-ui.php`
2. ç‚¹å‡»"ç”Ÿæˆ Schema æ–‡ä»¶"æŒ‰é’®

**æ–¹å¼ 2ï¼šä½¿ç”¨å‘½ä»¤è¡Œ**

```bash
# Docker ç¯å¢ƒ
docker compose exec -T php php /var/www/database/generate-schema.php

# æœ¬åœ°ç¯å¢ƒ
php database/generate-schema.php
```

è¿™ä¼šå°†æ•°æ®åº“ä¸­æ‰€æœ‰ `mini_` å‰ç¼€è¡¨çš„ç»“æ„å¯¼å‡ºåˆ° `database/schema.json`ã€‚

### 2. åŒæ­¥æ•°æ®åº“

#### ä½¿ç”¨ Web UIï¼ˆæ¨èï¼‰

1. è®¿é—®ï¼š`http://localhost:8082/sync-ui.php`
2. ç¼–è¾‘ `database/schema.json` æ–‡ä»¶
3. å‹¾é€‰"é¢„è§ˆæ¨¡å¼"æŸ¥çœ‹ SQL
4. ç¡®è®¤æ— è¯¯åï¼Œå–æ¶ˆé¢„è§ˆæ¨¡å¼ï¼Œç‚¹å‡»"æ‰§è¡ŒåŒæ­¥"

#### ä½¿ç”¨å‘½ä»¤è¡Œ

```bash
# Docker ç¯å¢ƒ
docker compose exec -T php php /var/www/database/sync.php --schema

# æœ¬åœ°ç¯å¢ƒ
php database/sync.php --schema
```

#### é¢„è§ˆæ¨¡å¼ï¼ˆä¸æ‰§è¡Œï¼Œåªæ˜¾ç¤º SQLï¼‰

```bash
php database/sync.php --schema --dry-run
```

## Schema æ–‡ä»¶æ ¼å¼

`schema.json` æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š

```json
{
  "version": "1.0.0",
  "generated_at": "2025-01-XX",
  "tables": {
    "mini_brand": {
      "columns": {
        "id": {
          "type": "int(11)",
          "null": false,
          "auto_increment": true,
          "comment": "ID"
        },
        "name": {
          "type": "varchar(100)",
          "null": false,
          "comment": "å“ç‰Œåç§°"
        },
        "slug": {
          "type": "varchar(100)",
          "null": true,
          "comment": "URLåˆ«å"
        }
      },
      "primary_key": ["id"],
      "indexes": {
        "slug": ["slug"],
        "status": ["status"]
      },
      "engine": "InnoDB",
      "charset": "utf8mb4",
      "comment": "å“ç‰Œè¡¨"
    }
  }
}
```

### å­—æ®µå®šä¹‰è¯´æ˜

- `type`: å­—æ®µç±»å‹ï¼Œå¦‚ `int(11)`, `varchar(100)`, `text` ç­‰
- `null`: æ˜¯å¦å…è®¸ NULLï¼Œ`true` æˆ– `false`
- `default`: é»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰ï¼Œå­—ç¬¦ä¸²ã€æ•°å­—æˆ– `null`
- `auto_increment`: æ˜¯å¦è‡ªå¢ï¼Œ`true` æˆ– `false`ï¼ˆå¯é€‰ï¼‰
- `comment`: å­—æ®µæ³¨é‡Šï¼ˆå¯é€‰ï¼‰

### ç´¢å¼•å®šä¹‰è¯´æ˜

- æ™®é€šç´¢å¼•ï¼š`"index_name": ["column1", "column2"]`
- å”¯ä¸€ç´¢å¼•ï¼š`"index_name": {"columns": ["column1"], "unique": true}`

## å·¥ä½œæµç¨‹

### æ—¥å¸¸å¼€å‘æµç¨‹

1. **ä¿®æ”¹è¡¨ç»“æ„**ï¼šç¼–è¾‘ `database/schema.json`ï¼Œæ·»åŠ /ä¿®æ”¹/åˆ é™¤å­—æ®µæˆ–ç´¢å¼•

2. **é¢„è§ˆå˜æ›´**ï¼ˆä½¿ç”¨ Web UIï¼‰ï¼š
   - è®¿é—® `http://localhost:8082/sync-ui.php`
   - å‹¾é€‰"é¢„è§ˆæ¨¡å¼"
   - ç‚¹å‡»"æ‰§è¡ŒåŒæ­¥"
   - æŸ¥çœ‹æ—¥å¿—ä¸­çš„ SQL è¯­å¥

3. **æ‰§è¡ŒåŒæ­¥**ï¼š
   - å–æ¶ˆå‹¾é€‰"é¢„è§ˆæ¨¡å¼"
   - ç‚¹å‡»"æ‰§è¡ŒåŒæ­¥"
   - æˆ–ä½¿ç”¨å‘½ä»¤è¡Œï¼š`php database/sync.php --schema`

4. **æäº¤åˆ° Git**ï¼š
   ```bash
   git add database/schema.json
   git commit -m "æ›´æ–°è¡¨ç»“æ„"
   ```

### å›¢é˜Ÿåä½œæµç¨‹

1. **æ‹‰å–æœ€æ–°ä»£ç **ï¼ˆåŒ…å«æ›´æ–°çš„ schema.jsonï¼‰

2. **æ‰§è¡ŒåŒæ­¥**ï¼ˆä½¿ç”¨ Web UI æˆ–å‘½ä»¤è¡Œï¼‰ï¼š
   - Web UIï¼šè®¿é—®å·¥å…·é¡µé¢ï¼Œç‚¹å‡»"æ‰§è¡ŒåŒæ­¥"
   - å‘½ä»¤è¡Œï¼š`php database/sync.php --schema`

3. ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å·®å¼‚å¹¶åŒæ­¥æ•°æ®åº“ç»“æ„

## åŠŸèƒ½ç‰¹æ€§

### è‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†

- âœ… **æ–°å¢è¡¨**ï¼šå¦‚æœ schema ä¸­æœ‰ä½†æ•°æ®åº“ä¸­æ²¡æœ‰ï¼Œè‡ªåŠ¨åˆ›å»º
- âœ… **æ–°å¢å­—æ®µ**ï¼šè‡ªåŠ¨æ·»åŠ å­—æ®µåˆ°è¡¨
- âœ… **ä¿®æ”¹å­—æ®µ**ï¼šè‡ªåŠ¨ä¿®æ”¹å­—æ®µç±»å‹ã€NULL çº¦æŸã€é»˜è®¤å€¼ç­‰
- âœ… **æ–°å¢ç´¢å¼•**ï¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•
- âœ… **ä¿®æ”¹ç´¢å¼•**ï¼šè‡ªåŠ¨æ›´æ–°ç´¢å¼•å®šä¹‰

### å®‰å…¨æœºåˆ¶

- âš ï¸ **åˆ é™¤å­—æ®µ**ï¼šæ£€æµ‹åˆ°å­—æ®µåˆ é™¤æ—¶ï¼Œåªè¾“å‡ºè­¦å‘Šï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æ•°æ®è¿ç§»
- âš ï¸ **åˆ é™¤è¡¨**ï¼šæ£€æµ‹åˆ°è¡¨åˆ é™¤æ—¶ï¼Œåªè¾“å‡ºè­¦å‘Šï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
- ğŸ“ **ç‰ˆæœ¬è®°å½•**ï¼šæ¯æ¬¡åŒæ­¥åè®°å½•è¡¨ç»“æ„ç‰ˆæœ¬ï¼ˆå“ˆå¸Œå€¼ï¼‰
- ğŸ” **é¢„è§ˆæ¨¡å¼**ï¼šæ”¯æŒ `--dry-run` é¢„è§ˆ SQL ä¸æ‰§è¡Œ

## æ³¨æ„äº‹é¡¹

1. **Schema æ–‡ä»¶ç»´æŠ¤**ï¼šæ¯æ¬¡ä¿®æ”¹è¡¨ç»“æ„åï¼Œéœ€è¦æ‰‹åŠ¨æ›´æ–° `schema.json`

2. **åˆ é™¤å­—æ®µ/è¡¨**ï¼šç³»ç»Ÿä¸ä¼šè‡ªåŠ¨åˆ é™¤å­—æ®µæˆ–è¡¨ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†ï¼š
   - å…ˆå¤‡ä»½æ•°æ®
   - æ‰‹åŠ¨æ‰§è¡Œ `ALTER TABLE ... DROP COLUMN` æˆ– `DROP TABLE`
   - æ›´æ–° schema.json

3. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå»ºè®®å°† `schema.json` çº³å…¥ Git ç‰ˆæœ¬æ§åˆ¶

4. **ç”Ÿäº§ç¯å¢ƒ**ï¼šç”Ÿäº§ç¯å¢ƒä½¿ç”¨å‰ï¼ŒåŠ¡å¿…å…ˆé¢„è§ˆï¼ˆ`--dry-run`ï¼‰

5. **æ•°æ®è¿ç§»**ï¼šå­—æ®µç±»å‹å˜æ›´ã€åˆ é™¤å­—æ®µç­‰æ“ä½œå¯èƒ½éœ€è¦æ•°æ®è¿ç§»ï¼Œè¯·è°¨æ…å¤„ç†

## ç¤ºä¾‹åœºæ™¯

### åœºæ™¯ 1: æ·»åŠ æ–°å­—æ®µ

1. ç¼–è¾‘ `schema.json`ï¼Œåœ¨ `mini_product` è¡¨ä¸­æ·»åŠ  `view_count` å­—æ®µï¼š
```json
"view_count": {
  "type": "int(11)",
  "null": false,
  "default": 0,
  "comment": "æµè§ˆæ¬¡æ•°"
}
```

2. é¢„è§ˆå˜æ›´ï¼š
```bash
php database/sync.php --schema --dry-run
```

3. æ‰§è¡ŒåŒæ­¥ï¼š
```bash
php database/sync.php --schema
```

### åœºæ™¯ 2: ä¿®æ”¹å­—æ®µç±»å‹

1. ç¼–è¾‘ `schema.json`ï¼Œå°† `mini_product.name` å­—æ®µç±»å‹ä» `varchar(200)` æ”¹ä¸º `varchar(300)`

2. æ‰§è¡ŒåŒæ­¥ï¼š
```bash
php database/sync.php --schema
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆå¹¶æ‰§è¡Œï¼š
```sql
ALTER TABLE `mini_product`
  MODIFY COLUMN `name` varchar(300) NOT NULL COMMENT 'äº§å“åç§°';
```

### åœºæ™¯ 3: æ·»åŠ ç´¢å¼•

1. ç¼–è¾‘ `schema.json`ï¼Œåœ¨ `mini_product` è¡¨çš„ `indexes` ä¸­æ·»åŠ ï¼š
```json
"idx_createtime": ["createtime"]
```

2. æ‰§è¡ŒåŒæ­¥ï¼š
```bash
php database/sync.php --schema
```

ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ã€‚

## æ•…éšœæ’æŸ¥

### Schema æ–‡ä»¶ä¸å­˜åœ¨

```
âš  Schema æ–‡ä»¶ä¸å­˜åœ¨: database/schema.json
è¯·å…ˆè¿è¡Œ: php database/generate-schema.php
```

**è§£å†³æ–¹æ¡ˆ**ï¼šè¿è¡Œ `generate-schema.php` ç”Ÿæˆåˆå§‹ schema æ–‡ä»¶ã€‚

### å­—æ®µåˆ é™¤è­¦å‘Š

```
è­¦å‘Š: å­—æ®µ mini_product.old_field åœ¨ schema ä¸­ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†æ•°æ®è¿ç§»
```

**è§£å†³æ–¹æ¡ˆ**ï¼šè¿™æ˜¯æ­£å¸¸çš„è­¦å‘Šï¼Œå¦‚æœéœ€è¦åˆ é™¤å­—æ®µï¼Œè¯·ï¼š
1. å¤‡ä»½æ•°æ®
2. æ‰‹åŠ¨æ‰§è¡Œ `ALTER TABLE mini_product DROP COLUMN old_field`
3. æ›´æ–° schema.jsonï¼ˆç§»é™¤è¯¥å­—æ®µå®šä¹‰ï¼‰

### SQL æ‰§è¡Œå¤±è´¥

æ£€æŸ¥é”™è¯¯ä¿¡æ¯ï¼Œå¸¸è§åŸå› ï¼š
- SQL è¯­æ³•é”™è¯¯
- å­—æ®µç±»å‹ä¸å…¼å®¹
- ç´¢å¼•åç§°å†²çª
- å¤–é”®çº¦æŸå†²çª

## ç›¸å…³æ–‡ä»¶

- `database/schema.json` - Schema å®šä¹‰æ–‡ä»¶
- `database/sync.php` - ä¸»åŒæ­¥è„šæœ¬
- `database/generate-schema.php` - Schema ç”Ÿæˆå·¥å…·
- `database/SchemaParser.php` - Schema è§£æå™¨
- `database/DatabaseInspector.php` - æ•°æ®åº“ç»“æ„æå–å™¨
- `database/DiffGenerator.php` - å·®å¼‚æ£€æµ‹å’Œ SQL ç”Ÿæˆå™¨

